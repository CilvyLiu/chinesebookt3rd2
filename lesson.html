<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步点读引擎 - 通用模板</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <link rel="stylesheet" href="lesson1.css">
</head>
<body class="lesson-engine">

    <div id="app">
        <section id="reader-container">
            <div id="pdf-scroll-view">
                <div id="pdf-render-wrapper">
                    <canvas id="pdf-canvas"></canvas>
                    <div id="hotspot-overlay"></div>
                </div>
            </div>
        </section>

        <aside id="teaching-panel">
            <header id="lesson-header">
                <h1 id="title-display">正在加载...</h1>
                <nav id="page-switcher"></nav>
            </header>

            <article id="content-display">
                <div class="placeholder">请点击左侧课文开启学习</div>
            </article>

            <footer id="lesson-footer">
                <button onclick="location.href='index.html'" class="btn-home">回目录</button>
            </footer>
        </aside>
    </div>

    <script>
        // --- 全栈专家驱动逻辑 ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id') || '1'; 
        let currentPdf = null;
        let lessonConfig = null;
        let writerInstance = null;

        // 1. 加载配置并启动
        async function initEngine() {
            try {
                const response = await fetch(`./data/lesson${lessonId}.json`);
                lessonConfig = await response.json();
                document.getElementById('title-display').innerText = lessonConfig.title;

                currentPdf = await pdfjsLib.getDocument('book.pdf').promise;
                
                // 构建页码导航
                const nav = document.getElementById('page-switcher');
                lessonConfig.pages.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = "page-btn";
                    btn.innerText = p.pageNo;
                    btn.onclick = () => renderPdfPage(p.pageNo);
                    nav.appendChild(btn);
                });

                // 默认渲染第一页
                renderPdfPage(lessonConfig.pages[0].pageNo);
            } catch (err) {
                console.error("Engine Error:", err);
            }
        }

        // 2. 渲染 PDF 页面
        async function renderPdfPage(num) {
            const page = await currentPdf.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            // 绘制热区
            const overlay = document.getElementById('hotspot-overlay');
            overlay.innerHTML = '';
            const pageData = lessonConfig.pages.find(p => p.pageNo === num);
            
            pageData.hotspots.forEach(spot => {
                const div = document.createElement('div');
                div.className = `hotspot hotspot-${spot.type}`;
                div.style.cssText = `left:${spot.pos[0]}%; top:${spot.pos[1]}%; width:${spot.pos[2]}%; height:${spot.pos[3]}%; position:absolute;`;
                div.onclick = () => handleActivation(spot);
                overlay.appendChild(div);
            });
        }

        // 3. 处理热区点击（板块传送）
        function handleActivation(spot) {
            // TTS 朗读
            window.speechSynthesis.cancel();
            const speech = new SpeechSynthesisUtterance(spot.text || spot.char);
            speech.lang = 'zh-CN';
            speech.rate = 0.85;
            window.speechSynthesis.speak(speech);

            const display = document.getElementById('content-display');
            
            if (spot.type === 'poem') {
                display.innerHTML = `
                    <div class="teaching-card poem-type">
                        <section class="expert-note"><h3>名师导学</h3><p>${spot.expand.expert_note || spot.expand.note}</p></section>
                        <section class="science-box"><h3>科学知识</h3><p>${spot.expand.science}</p></section>
                        <section class="quiz-box"><h3>思考题</h3><p>${spot.expand.qa ? spot.expand.qa.q : spot.expand.quiz}</p></section>
                    </div>`;
            } else if (spot.type === 'word') {
                display.innerHTML = `
                    <div class="teaching-card word-type">
                        <div id="writer-target"></div>
                        <div class="word-detail">
                            <h2>${spot.char} <span>${spot.pinyin}</span></h2>
                            <p class="zili"><strong>字理：</strong>${spot.analysis ? spot.analysis.zili : spot.expand.zili}</p>
                            <p class="group"><strong>组词：</strong>${(spot.analysis ? spot.analysis.group : spot.expand.group).join('、')}</p>
                        </div>
                        <div class="word-actions">
                            <button onclick="writerInstance.animate()">演示笔顺</button>
                            <button onclick="writerInstance.quiz()">听写测试</button>
                        </div>
                    </div>`;
                
                // 笔顺初始化：自动绘制
                writerInstance = HanziWriter.create('writer-target', spot.char, {
                    width: 150, height: 150, padding: 5,
                    strokeAnimationSpeed: 1, strokeColor: '#d32f2f'
                });
                writerInstance.animate();
            }
        }

        initEngine();
    </script>
</body>
</html>
