<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæ­¥ç‚¹è¯»å­¦ä¹  - ä¸‰å¹´çº§è¯­æ–‡ä¸‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --primary: #2e7d32; --accent: #ff9800; --bg: #f0f2f5; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: "PingFang SC", sans-serif; background: #525659; }
        
        /* å“åº”å¼å¸ƒå±€ï¼šPCç«¯æ¨ªæ’ï¼Œæ‰‹æœºç«¯ç«–æ’ */
        .main-container { display: flex; height: 100vh; flex-direction: row; }
        @media (max-width: 800px) { .main-container { flex-direction: column; } }

        /* å·¦ä¾§ï¼šPDFå±•ç¤ºåŒº */
        #pdf-viewport { flex: 1; overflow: auto; position: relative; display: flex; justify-content: center; padding: 20px; }
        #pdf-wrapper { position: relative; background: white; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        canvas { display: block; }

        /* äº¤äº’çƒ­åŒºå±‚ */
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .hotspot { position: absolute; pointer-events: auto; cursor: pointer; border: 2px solid transparent; border-radius: 6px; transition: 0.2s; }
        .hotspot:hover { background: rgba(255, 152, 0, 0.15); border-color: var(--accent); }

        /* å³ä¾§ï¼š50å¹´ç»éªŒåå¸ˆå¯¼å­¦æ¡ˆé¢æ¿ */
        #side-panel { width: 380px; background: white; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 10; }
        @media (max-width: 800px) { #side-panel { width: 100%; height: 40%; } }

        .panel-header { background: var(--primary); color: white; padding: 20px; }
        .panel-header h2 { margin: 0; font-size: 1.2rem; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* ä¸“å®¶æ¨¡å—æ ·å¼ */
        .module { background: #f9fbf9; border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .module-title { font-weight: bold; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; }
        .module-title::before { content: "ğŸ’¡"; margin-right: 8px; }
        .pinyin { color: #d35400; font-weight: bold; font-family: "Courier New", monospace; }
        .quiz-box { background: #fff8e1; border: 1px dashed #ffd54f; padding: 12px; border-radius: 4px; }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: white; }
        button.active { background: var(--primary); color: white; border: none; }
    </style>
</head>
<body>

<div class="main-container">
    <div id="pdf-viewport">
        <div id="pdf-wrapper">
            <canvas id="pdf-canvas"></canvas>
            <div id="interaction-layer"></div>
        </div>
    </div>

    <div id="side-panel">
        <div class="panel-header">
            <h2 id="lesson-title">åŠ è½½ä¸­...</h2>
            <div id="page-indicator" style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;"></div>
        </div>
        <div class="content-scroll" id="expert-content">
            <div style="text-align: center; color: #888; margin-top: 50px;">
                è¯·ç‚¹å‡»å·¦ä¾§è¯¾æ–‡å†…å®¹<br>å¼€å¯æ·±åº¦ç‚¹è¯»æ¨¡å¼
            </div>
        </div>
        <div class="bottom-nav">
            <button onclick="location.href='index.html'">å›ç›®å½•</button>
            <div id="page-btns"></div>
        </div>
    </div>
</div>

<script>
// --- é…ç½®åˆå§‹åŒ– ---
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

const urlParams = new URLSearchParams(window.location.search);
const lessonId = urlParams.get('id') || '1'; // é»˜è®¤åŠ è½½ç¬¬ä¸€è¯¾
const pdfPath = 'book.pdf';

let g_pdfDoc = null;
let g_lessonConfig = null;
let g_currentPage = 0;

// --- 1. è·å– JSON æ•°æ® (ä¼ é€æ¿å—) ---
fetch(`./data/lesson${lessonId}.json`)
    .then(res => res.json())
    .then(data => {
        g_lessonConfig = data;
        document.getElementById('lesson-title').innerText = data.title;
        initPDF();
    })
    .catch(err => alert("æ— æ³•åŠ è½½è¯¾ç¨‹æ•°æ®ï¼Œè¯·æ£€æŸ¥ data/ ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶"));

// --- 2. åˆå§‹åŒ– PDF ---
function initPDF() {
    pdfjsLib.getDocument(pdfPath).promise.then(pdf => {
        g_pdfDoc = pdf;
        // è‡ªåŠ¨è·³è½¬åˆ° JSON é…ç½®çš„ç¬¬ä¸€é¡µ
        renderLessonPage(g_lessonConfig.pages[0].pdfPageNo);
        renderPageButtons();
    });
}

// --- 3. æ¸²æŸ“æŒ‡å®šé¡µç  ---
async function renderLessonPage(pageNum) {
    g_currentPage = pageNum;
    const page = await g_pdfDoc.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.5 });
    
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    
    document.getElementById('page-indicator').innerText = `PDFé¡µç : ${pageNum}`;
    setupHotspots(pageNum);
}

// --- 4. è®¾ç½®äº¤äº’çƒ­åŒº (æ ¹æ® JSON åæ ‡) ---
function setupHotspots(pageNum) {
    const layer = document.getElementById('interaction-layer');
    layer.innerHTML = '';
    
    const pageConfig = g_lessonConfig.pages.find(p => p.pdfPageNo === pageNum);
    if (!pageConfig) return;

    pageConfig.hotspots.forEach(spot => {
        const div = document.createElement('div');
        div.className = 'hotspot';
        // ä½¿ç”¨ç™¾åˆ†æ¯”å¸ƒå±€æ–¹æ¡ˆ
        div.style.left = spot.pos[0] + '%';
        div.style.top = spot.pos[1] + '%';
        div.style.width = spot.pos[2] + '%';
        div.style.height = spot.pos[3] + '%';
        
        div.onclick = () => {
            handlePointClick(spot);
        };
        layer.appendChild(div);
    });
}

// --- 5. å¤„ç†ç‚¹å‡»ï¼šTTS + ä¸“å®¶è¡¥å…… ---
function handlePointClick(spot) {
    // A. è‡ªåŠ¨ TTS (æ ‡å‡†æ™®é€šè¯)
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(spot.tts_text || spot.text);
    msg.lang = 'zh-CN';
    msg.rate = 0.85; // 8å²å­©å­è¯­é€Ÿ
    window.speechSynthesis.speak(msg);

    // B. æ›´æ–° 50 å¹´ç»éªŒä¸“å®¶é¢æ¿
    const panel = document.getElementById('expert-content');
    let html = `<h3>${spot.text.substring(0,10)}${spot.text.length>10?'...':''}</h3>`;
    
    if(spot.expand) {
        if(spot.expand.pinyin) html += `<p class="pinyin">${spot.expand.pinyin}</p>`;
        if(spot.expand.zili) html += `<div class="module"><div class="module-title">å­—ç†æ–‡åŒ–</div>${spot.expand.zili}</div>`;
        if(spot.expand.note) html += `<div class="module"><div class="module-title">ä¸“å®¶èµæ</div>${spot.expand.note}</div>`;
        if(spot.expand.science) html += `<div class="module"><div class="module-title">ç§‘å­¦ç™¾ç§‘</div>${spot.expand.science}</div>`;
        if(spot.expand.quiz) html += `<div class="quiz-box"><b>æ€è€ƒé¢˜ï¼š</b>${spot.expand.quiz}</div>`;
    }
    
    panel.innerHTML = html;
}

// è¾…åŠ©ï¼šæ¸²æŸ“åˆ‡é¡µæŒ‰é’®
function renderPageButtons() {
    const btnContainer = document.getElementById('page-btns');
    g_lessonConfig.pages.forEach((p, index) => {
        const btn = document.createElement('button');
        btn.innerText = `ç¬¬${index + 1}é¡µ`;
        btn.onclick = () => renderLessonPage(p.pdfPageNo);
        btnContainer.appendChild(btn);
    });
}
</script>

</body>
</html>
