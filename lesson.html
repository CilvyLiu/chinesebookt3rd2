<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæ­¥ç‚¹è¯»å¼•æ“ - Nova å…¨æ ˆé‡æ„ç‰ˆ</title>
    <script src="./js/hanzi-writer.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id') || '1';
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = `./css/lesson${lessonId}.css`;
        document.head.appendChild(link);
    </script>
</head>
<body class="lesson-engine">

    <div id="app">
        <section id="reader-container">
            <div id="pdf-scroll-view">
                <div id="pdf-render-wrapper" style="position: relative; display: inline-block;">
                    <canvas id="pdf-canvas"></canvas>
                    <div id="hotspot-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                </div>
            </div>
        </section>

        <aside id="teaching-panel">
            <header id="lesson-header">
                <h1 id="title-display">è½½å…¥ä¸­...</h1>
                <nav id="page-switcher"></nav>
            </header>
            <article id="content-display">
                <div class="placeholder">è¯·ç‚¹å‡»è¯¾æ–‡å†…å®¹å¼€å§‹å­¦ä¹ </div>
            </article>
            <footer id="lesson-footer">
                <button onclick="location.href='index.html'" class="ctrl-btn" style="background:#444; width: 80%;">è¿”å›ç›®å½•</button>
            </footer>
        </aside>
    </div>

    <script src="./js/pdf.js"></script>
    
    <script>
        /**
         * 30å¹´ç»éªŒå·¥ç¨‹å®è·µï¼šä¿æŒçŠ¶æ€é«˜åº¦éš”ç¦»
         */
        const pdfjsLib = window['pdfjs-dist/build/pdf'] || window.pdfjsLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = './js/pdf.worker.js';

        const state = {
            currentPdf: null,
            lessonConfig: null,
            writer: null,
            player: new Audio(),
            isFullReading: false,
            currentPage: null,
            renderTask: null
        };

        const getAudioUrl = (text) => `https://tts.baidu.com/text2audio?tex=${encodeURIComponent(text)}&cuid=baike&lan=zh&ctp=1&pdt=301&vol=9&rate=32&per=4`;

        // åˆå§‹åŒ–å¼•æ“
        async function init() {
            try {
                const res = await fetch(`./data/lesson${lessonId}.json`);
                state.lessonConfig = await res.json();
                document.getElementById('title-display').innerText = state.lessonConfig.title;

                state.currentPdf = await pdfjsLib.getDocument({
                    url: state.lessonConfig.pdfPath || './book.pdf',
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/cmaps/',
                    cMapPacked: true
                }).promise;

                setupNavigation();
                renderPage(state.lessonConfig.pages[0].pdfPageNo);
            } catch (e) { console.error("Critical Engine Error:", e); }
        }

        function setupNavigation() {
            const nav = document.getElementById('page-switcher');
            nav.innerHTML = '';
            
            const autoBtn = document.createElement('button');
            autoBtn.className = "page-btn";
            autoBtn.style.background = "#f57c00";
            autoBtn.innerHTML = "âš¡ å…¨æ–‡æœ—è¯»";
            autoBtn.onclick = () => startAutoPlay();
            nav.appendChild(autoBtn);

            state.lessonConfig.pages.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "page-btn";
                btn.innerText = `P${p.pdfPageNo}`;
                btn.onclick = () => renderPage(p.pdfPageNo);
                nav.appendChild(btn);
            });
        }

        // æ¸²æŸ“PDFé¡µé¢åŠçƒ­åŒº
        async function renderPage(pageNum) {
            state.isFullReading = false;
            state.player.pause();
            if (state.renderTask) state.renderTask.cancel();

            const page = await state.currentPdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            state.renderTask = page.render({ canvasContext: ctx, viewport: viewport });
            await state.renderTask.promise;

            // æ ¸å¿ƒé‡æ„ï¼šåŸºäº JSON æ•°æ®ç›´æ¥ç”Ÿæˆäº¤äº’å±‚ï¼Œä¸ä¾èµ–ä¸ç¨³å®šæ–‡æœ¬æ‹¾å–
            const overlay = document.getElementById('hotspot-overlay');
            overlay.innerHTML = '';
            overlay.style.pointerEvents = 'auto'; // å¼€å¯ç‚¹å‡»

            const pageData = state.lessonConfig.pages.find(p => p.pdfPageNo === pageNum);
            state.currentPage = pageData;

            // è·å– PDF æ–‡æœ¬ä½ç½®ç”¨äºç²¾ç¡®å®šä½
            const textContent = await page.getTextContent();
            
            textContent.items.forEach(item => {
                const spot = pageData.hotspots.find(s => 
                    (s.char && item.str.includes(s.char)) || 
                    (s.search && item.str.includes(s.search)) ||
                    (s.search && s.search.includes(item.str.trim()))
                );

                if (spot) {
                    const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                    const div = document.createElement('div');
                    div.className = "hotspot clickable-area";
                    div.style.left = `${(tx[4] / viewport.width) * 100}%`;
                    div.style.top = `${((tx[5] - item.height) / viewport.height) * 100}%`;
                    div.style.width = `${(item.width / viewport.width) * 100}%`;
                    div.style.height = `${(item.height / viewport.height) * 100}%`;
                    div.style.position = 'absolute';
                    
                    div.onclick = (e) => {
                        e.stopPropagation();
                        state.isFullReading = false;
                        activateSpot(spot, div);
                    };
                    overlay.appendChild(div);
                }
            });
        }

        // æ¿€æ´»ç‰¹å®šçŸ¥è¯†ç‚¹ï¼ˆç‚¹è¯»/å…¨æ–‡å¾ªç¯è°ƒç”¨ï¼‰
        function activateSpot(spot, element) {
            // 1. é«˜äº®åˆ‡æ¢
            document.querySelectorAll('.active-hotspot').forEach(el => el.classList.remove('active-hotspot'));
            if (element) element.classList.add('active-hotspot');

            // 2. æ¸²æŸ“æ•™å­¦é¢æ¿
            renderTeachingCard(spot);

            // 3. è¯­éŸ³æ’­æŠ¥
            const ttsText = spot.type === 'poem' 
                ? spot.content || spot.search 
                : `${spot.char}ã€‚æ‹¼éŸ³ï¼š${spot.pinyin}ã€‚ç»„è¯ï¼š${(spot.expand.group || [])[0] || ''}`;
            
            state.player.src = getAudioUrl(ttsText);
            state.player.play().catch(e => console.warn("Autoplay blocked"));
        }

        function renderTeachingCard(spot) {
            const container = document.getElementById('content-display');
            
            if (spot.type === 'poem') {
                container.innerHTML = `
                    <div class="teaching-card expert-mode">
                        <section class="card-section">
                            <h3><span class="icon">ğŸ’¡</span> åå¸ˆèµæ</h3>
                            <p class="content-text">${spot.expand.note}</p>
                        </section>
                        <section class="card-section science-box">
                            <h3><span class="icon">ğŸ§ª</span> ç§‘å­¦ç™¾ç§‘</h3>
                            <p class="content-text">${spot.expand.science || spot.expand.article || 'èµ„æ–™æ•´ç†ä¸­...'}</p>
                        </section>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="teaching-card word-mode">
                        <div class="hanzi-canvas-wrap">
                            <div id="writer-target"></div>
                        </div>
                        <div class="word-info">
                            <h2 class="char-title">${spot.char} <small class="pinyin-tag">${spot.pinyin}</small></h2>
                        </div>
                        <div class="details-grid">
                            <div class="grid-item"><strong>ã€ç»„è¯ã€‘</strong>${(spot.expand.group || []).join('ã€')}</div>
                            <div class="grid-item"><strong>ã€å­—ç†ã€‘</strong>${spot.expand.zili || 'è§è¯¦è§£'}</div>
                            <div class="grid-item danger"><strong>ã€æ˜“é”™ã€‘</strong>${spot.expand.error || 'æ³¨æ„è§„èŒƒå†™å­—'}</div>
                        </div>
                        <button class="animate-btn" onclick="state.writer.animateCharacter()">æ¼”ç¤ºç¬”é¡º</button>
                    </div>`;

                // ç¬”é¡ºåˆå§‹åŒ–ï¼ˆç¡®ä¿ DOM å·²æŒ‚è½½ï¼‰
                if (spot.char) {
                    state.writer = HanziWriter.create('writer-target', spot.char, {
                        width: 180, height: 180, padding: 10,
                        strokeColor: '#d32f2f', outlineColor: '#eee',
                        showOutline: true, delayBetweenStrokes: 300
                    });
                    state.writer.animateCharacter();
                }
            }
        }

        async function startAutoPlay() {
            if (state.isFullReading) {
                state.isFullReading = false;
                state.player.pause();
                return;
            }

            state.isFullReading = true;
            const hotspots = state.currentPage.hotspots;

            for (const spot of hotspots) {
                if (!state.isFullReading) break;

                // æ‰¾åˆ°å¯¹åº”çš„ DOM å…ƒç´ è¿›è¡ŒåŒæ­¥è§†è§‰é«˜äº®
                const elements = document.getElementById('hotspot-overlay').children;
                let targetEl = null;
                for (let el of elements) {
                    // è¿™é‡Œåˆ©ç”¨ç®€å•çš„é€»è¾‘å…³è”
                    targetEl = el; // æ¼”ç¤ºç®€åŒ–ï¼Œå®é™…å¯æ ¹æ®ç´¢å¼•æˆ–ID
                }

                activateSpot(spot, targetEl);

                // ç­‰å¾…éŸ³é¢‘æ’­æ”¾å®Œæ¯•
                await new Promise(resolve => {
                    state.player.onended = resolve;
                    state.player.onerror = resolve;
                });
                
                // åœé¡¿ 1 ç§’
                await new Promise(r => setTimeout(r, 1000));
            }
            state.isFullReading = false;
        }

        // å¯åŠ¨æ‰§è¡Œ
        window.onload = init;
    </script>

    <style>
        /* è¡¥å……æ ¸å¿ƒæ ·å¼ï¼Œç¡®ä¿æ‹¾å–é¡ºæ»‘ */
        .clickable-area { cursor: pointer; border-radius: 2px; transition: background 0.3s; }
        .clickable-area:hover { background: rgba(249, 168, 37, 0.2); }
        .active-hotspot { background: rgba(249, 168, 37, 0.4) !important; border: 1px solid #f57c00; box-shadow: 0 0 8px rgba(249, 168, 37, 0.6); }
        .hanzi-canvas-wrap { background: #fff; border: 2px solid #eee; display: inline-block; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
        .animate-btn { background: #d32f2f; color: #fff; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .details-grid { text-align: left; background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px; line-height: 1.8; }
        .danger { color: #d32f2f; }
    </style>
</body>
</html>
